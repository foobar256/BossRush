#!/usr/bin/env sh
set -e

ROOT_DIR="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
USER_DIR="$ROOT_DIR/.godot_user"
export XDG_DATA_HOME="$USER_DIR/data"
export XDG_CONFIG_HOME="$USER_DIR/config"
export XDG_STATE_HOME="$USER_DIR/state"
mkdir -p "$XDG_DATA_HOME" "$XDG_CONFIG_HOME" "$XDG_STATE_HOME"

cd "$ROOT_DIR"
godot --headless --quit --log-file "$USER_DIR/godot.log"

run_tool() {
  tool="$1"
  shift
  if [ -x "$ROOT_DIR/.venv/bin/$tool" ]; then
    "$ROOT_DIR/.venv/bin/$tool" "$@"
  else
    "$tool" "$@"
  fi
}

export HOME="$USER_DIR"

failed=0

# Run automated tests for game over window functionality
echo "Running automated tests..."
if [ -f "tests/run_tests.gd" ]; then
  # Create a temporary test runner scene
  cat > "tests/test_runner.tscn" << 'EOF'
[gd_scene load_steps=2 format=3]

[ext_resource type="Script" path="res://tests/run_tests.gd" id="1_test_runner"]

[node name="TestRunner" type="Node"]
script = ExtResource("1_test_runner")
EOF
  
  # Run the tests in headless mode
  if godot --headless --script "tests/run_tests.gd" 2>&1 | tee "$USER_DIR/test_output.log"; then
    echo "✅ All automated tests passed!"
  else
    echo "❌ Automated tests failed!"
    failed=1
  fi
  
  # Clean up temporary files
  rm -f "tests/test_runner.tscn"
fi

# Run formatting and linting
run_tool gdformat scripts/ scenes/ || failed=1
run_tool gdlint scripts/ scenes/ || failed=1

# Check for any modified test files that need formatting
if [ -d "tests" ]; then
  run_tool gdformat tests/ || failed=1
  run_tool gdlint tests/ || failed=1
fi

[ "$failed" -eq 0 ] || exit 1
